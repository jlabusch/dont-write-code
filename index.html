<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Code reuse (considered hazardous)</title>

        <meta name="description" content="Safe code reuse in the age of npm">
        <meta name="author" content="Jacques Labuschagne">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/pale-imitations.css" id="theme">

        <!-- Code syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <link rel="stylesheet" href="font-awesome-4.3.0/css/font-awesome.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section>
                  <h1>Code reuse</h1>
                  <h3>(considered hazardous)</h3>
                  <p>
                    <small>
                      <a href="http://twitter.com/jlabusch"><i class="fa fa-twitter"></i> @jlabusch</a>
                    </small>
                  </p>
                  <aside class="notes">
                    Code reuse has come a long way.
                    Not so long ago, it was a totally normal thing for projects to roll their own
                    logging, config, message queues... All the boring and complicated shit that
                    takes time and doesn't actually solve the business need that brought you here
                    in the first place.
                  </aside>
                </section>

                <section>
                  <h3><em>&ldquo;Don't write code&rdquo;</em> is not a new sentiment.</h3>
                  <aside class="notes">
                    The crazy thing is that reuse is not a new idea. It just looked a lot different
                    back then. From what I've seen, the big shift in reuse has come not from
                    motivation, but in availability and DISCOVERability.
                    <p>
                    Instead of Alice adding her config parser to the company's common utils library,
                    it's now a case of publishing a module to NPM, where if you're lucky, you can
                    get feedback and even patches from other companies and hobbyists in the industry.
                    <p>
                    This has of course come hand-in-hand with greater acceptance of open source by
                    tech businesses - not just using, but actually contributing. Plus, empoyment
                    contracts seem to be nowhere near as restrictive.
                  </aside>
                </section>

                <section>
                    <p>
                        Need to do $X? <pre style="width:420px;"><code>{npm,pip,gem} install $X</code></pre>
                    </p>
                  <aside class="notes">
                    So when you need to do some boring generic thing, it's accepted that one
                    should first hit google and find an existing tool.
                  </aside>
                </section>

                <section>
                    <h3>But how do you pick good modules?</h3>
                  <aside class="notes">
                    Unfortunately -- and I know the plural of anecdote is not data -- I have
                    often seen people use the nearest thing to hand without really thinking
                    the choices through.<p>
                    For example, last year I saw a project (not us!) re-skin a site using
                    jQuery 1.2 (ca. 2008). It's just what they had lying around. No thought.
                    This year, they tried to integrate a new thing into the site and lo and
                    behold, it wouldn't play with jQuery 1.2. Pointless headache.
                    <p>
                    But ok, let's assume people care enough to go looking. It's still
                    not a given they'll make good choices. 
                  </aside>
                </section>

                <section>
                    <h3>Examples of terrible criteria</h3>
                    <p>
                        <ul class="fa-ul" style="list-style-type:none;">
                            <li class="fragment"><i class="fa-li fa fa-github"></i>Has many stars on GitHub</li>
                            <li class="fragment"><i class="fa-li fa fa-download"></i>Has many downloads this week on npmjs.org</li>
                            <li class="fragment"><i class="fa-li fa fa-twitter"></i>Someone tweeted about it</li>
                        </ul>
                    </p>
                    <aside class="notes">
                        Here are some examples of bad criteria that I've seen people use
                        to justify their selections...
                        <p>
                        Story: PyCon keynote speaker (Jacob Kaplan-Moss?) tweeted sudo pip install somepackage
                    </aside>
                </section>

                <section>
                    <h3>Better criteria</h3>
                    <p>
                        <ul class="fa-ul" style="list-style-type:none;">
                            <li class="fragment"><i class="fa-li fa fa-clock-o"></i>Been in stable production use for a while</li>
                            <li class="fragment"><i class="fa-li fa fa-bar-chart"></i>Healthy bug report/fix lifecycle</li>
                            <li class="fragment"><i class="fa-li fa fa-cube"></i>Good packaging and availability of updates</li>
                            <li class="fragment"><i class="fa-li fa fa-bug"></i>Periodic security reviews</li>
                            <li class="fragment" style="color:#163"><i class="fa-li fa fa-check-square-o"></i><em>(All the usual stuff about doing one thing well...)</em></li>
                        </ul>
                    </p>
                    <aside class="notes">
                        Boring = good.<p>
                        This stuff is not always obvious.
                    </aside>
                </section>

                <section>
                    <h3>Quick ecosystem recap&hellip;</h3>
                    <aside class="notes">
                        At this point, let's take a quick step back and talk about the rest of the stack
                    </aside>
                </section>

                <section data-background="img/ring-0.png" data-background-size="auto 100%">
                    <span style="position:absolute; top:-6em; left:0px">Your code</span>
                    <aside class="notes">
                        Usually when people say "don't reinvent the wheel," this is the layer they're
                        talking about.
                    </aside>
                </section>

                <section data-background="img/ring-1a.png" data-background-size="auto 100%">
                    <span style="position:absolute; top:-6em; left:0px">3<small><sup>rd</sup></small> party libs</span>
                    <aside class="notes">
                        For example Express, Passport.js
                    </aside>
                </section>

                <section data-background="img/ring-2a.png" data-background-size="auto 100%">
                    <span style="position:absolute; top:-6em; left:0px">Language stdlib</span>
                    <aside class="notes">
                        For example the core http server object
                    </aside>
                </section>

                <section data-background="img/ring-3a.png" data-background-size="auto 100%">
                    <span style="position:absolute; top:-6em; left:0px">OS/platform</span>
                    <aside class="notes">
                        Including common libraries like libxml2
                    </aside>
                </section>

                <section>
                    <h3>Hypothesis: candidates from outer rings are more likely to meet those criteria</h3>
                    <p>
                        <img width="auto" height="400px" data-src="img/ring-3a.png" alt="Rings">
                    </p>
                </section>

                <section>
                    <h3>Resource comparison</h3>
                    <p>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="fa fa-cogs"></i></td>
                                <td>OS/platform:</td>
                                <td>massive user base, funding</td>
                            <tr>
                            <tr>
                                <td><i class="fa fa-database"></i></td>
                                <td>Lang stdlib:</td>
                                <td>large user base, some funding</td>
                            <tr>
                            <tr>
                                <td><i class="fa fa-code-fork"></i></td>
                                <td>3<small><sup>rd</sup></small> party libs:</td>
                                <td>highly variable, need to research</td>
                            <tr>
                            <tr>
                                <td><i class="fa fa-code"></i></td>
                                <td>Your code:</td>
                                <td>usually lean as hell</td>
                            <tr>
                        </tbody>
                    </table>
                    <aside class="notes">
                        e.g. Node Foundation plat member: $500k USD commitment
                    </aside>
                    </p>
                </section>

                <section data-background="img/unpopular_puffin.jpg" data-background-size="100% auto">
                    <h1 style="text-shadow:2px 2px 4px rgba(0,0,0,0.8)">On to some examples</h1>
                </section>

                <section>
                    <h3>Daemonizing your server</h3>
                    <p>
                        <img width="auto" height="400px" data-src="img/daemon.png" alt="Daemon">
                    </p>
                </section>

                <section>
                    <h3>Daemonizing your server</h3>
                    <p>
                        <pre><code style="word-wrap: break-word;">require('daemon')();

console.log("Yay I'm now a daemon! Right?");</code></pre>
                    </p>
                    <p class="fragment">
                        <img width="auto" height="300px" data-src="img/disapproval.jpg" alt="Disapproval">
                    </p>
                </section>

                <section>
                    <h3>Daemonizing your server</h3>
                    <p>
                        <ul class="fa-ul" style="list-style-type:none;">
                            <li style="color:#163"><i class="fa-li fa fa-check-square-o"></i>Fork</li>
                            <li><i class="fa-li fa fa-square-o"></i>Write a pidfile</li>
                            <li><i class="fa-li fa fa-square-o"></i>Change umask</li>
                            <li><i class="fa-li fa fa-square-o"></i>Change UID/GID</li>
                            <li><i class="fa-li fa fa-square-o"></i>Set the process name</li>
                            <li style="color:#163"><i class="fa-li fa fa-check-square-o"></i>Clean up ENV</li>
                            <li style="color:#163"><i class="fa-li fa fa-check-square-o"></i>Change working dir</li>
                            <li><i class="fa-li fa fa-square-o"></i>Create a new session ID</li>
                            <li style="color:#163"><i class="fa-li fa fa-check-square-o"></i>Fix stdin/out/err</li>
                        </ul>
                    </p>
                </section>

                <section>
                    <h3>Better solutions</h3>
                    <p style="text-align:left">
                        Linux
                    </p>
                    <div style="margin-left:3em;padding-left:1em;width:300px;" class="inlinecode">start-stop-daemon</div>
                    <p style="text-align:left">
                        BSD
                    </p>
                    <div style="margin-left:3em;padding-left:1em;width:300px;" class="inlinecode">daemon</div>
                    <p>
                        <ul>
                            <li>They do all that stuff and more</li>
                            <li>They come from the OS/Platform layer</li>
                            <li>Only minor code changes required, like setting process name</li>
                        </ul>
                    </p>
                </section>

                <section>
                    <h3>Next: YAML parsing</h3>
                    <p>
                        <img width="auto" height="129px" data-src="img/yaml.png" alt="YAML">
                    </p>
                    <p class="fragment">
                        <img width="auto" height="310px" data-src="img/yaml-cve.png" alt="YAML-CVE">
                    </p>
                </section>

                <section>
                    <h3>Trying again with libyaml</h3>
                    <p>
                        <img width="auto" height="129px" data-src="img/yaml-native.png" alt="YAML">
                    </p>
                    <p class="fragment">
                        <img width="auto" height="310px" data-src="img/yaml-native-cve.png" alt="YAML-CVE">
                    </p>
                </section>

                <section>
                    <h3>What libyaml did right</h3>
                    <p>
                        By wrapping native libraries, it got the direct benefits of review by teams
                        like Red Hat Product Security, who found this CVE.
                    </p>
                </section>

                <section>
                    <h3>What libyaml did wrong</h3>
                    <p>
                        Re-use by copy/paste meant that the Node libyaml author had to get around to
                        patching his own copy of the native source. Just updating the OS copy of
                        the library didn't fix the problem.
                    </p>
                </section>

                <section>
                    <h3>libyaml hall of shame</h3>
                    <p>
                        Some libraries that wrap by copy/paste <em>still</em> haven't been updated for
                        this 2013 vulnerability. (https://github.com/tarruda/node-libyaml)
                    </p>
                </section>

                <section>
                    <h3>Next: npm, pip and gem</h3>
                    <p>
                        <ul class="fa-ul" style="list-style-type:none;">
                            <li class="fragment"><i class="fa-li fa fa-smile-o"></i>Undeniably convenient</li>
                            <li class="fragment"><i class="fa-li fa fa-bug"></i>Quality control is problematic - no moderation</li>
                            <li class="fragment"><i class="fa-li fa fa-chain"></i>Security nightmare - no review, no signing*</li>
                        </ul>
                        <aside class="notes">
                            https://github.com/pypa/pip/issues/425 - Jacob Kaplan-Moss getting people
                            to install a trick package.
                            [*] RubyGems CAN sign, but most don't, and there's no well-established chain
                            of trust - http://guides.rubygems.org/security/

                            Had to invent their own because OS packages moved too slowly.
                        </aside>
                    </p>
                </section>

                <section>
                    <h3>npm, pip and gem</h3>
                    <p>
                        Use tools like nsp to check your dependencies for
                        updates and vulnerabilities.
                        <pre style="width:120%;margin-left:-10%"><code>$ nsp audit-package
Name          Installed        Patched       Vulnerable Dependency
express         4.2.0    >=3.11 <4 || >=4.5  myapp > express@4.2.0
send            0.3.0         >= 0.8.4       myapp > express@4.2.0 > send@0.3.0
qs              0.6.6          >= 1.x        myapp > express@4.2.0 > qs@0.6.6
serve-static    1.1.0     ~1.6.5 || >=1.7.2  myapp > express@4.2.0 > serve-static@1.1.0</code></pre>
                       <small><em style="color:#163">(See also david-dm, gemcanary, &hellip;)</em></small>
                        <aside class="notes">
                            This is a shitshow, no two ways about it.

                            nodesecurity.io is only as good as its database.

                            "npm outdated" only checks your deps, is not recursive.
                        </aside>
                    </p>
                </section>

                <section>
                    <h3>Next: deployment</h3>
                    <p>nibbler, envoy, shake, roco, gogogo, deploy, sneaky, yala,
                    dploy, grunt-ftp-deploy, pushover, ploy, bora, deployjs, deployme,
                    edy, gitnodeploy, katapult, paratrooper, nin, rodent, deploy-goon, &hellip;
                    </p>
                    <h2 class="fragment">None of these should exist</h2>
                </section>

                <section>
                    <h3>Deployment should:</h3>
                    <p>
                        <ul class="fa-ul" style="list-style-type:none;">
                            <li class="fragment"><i class="fa-li fa fa-cube"></i>Use real packages (.deb, .rpm, &hellip;)</li>
                            <li class="fragment"><i class="fa-li fa fa-cogs"></i>Use real automation tools (puppet, ansible, &hellip;)</li>
                            <li class="fragment"><i class="fa-li fa fa-lock"></i>Deploy over SSH with pre-shared keys (FTP is never ok)</li>
                        </ul>
                        <aside class="notes">
                            Deploying via git is not scalable; too slow, too much extra data.

                            Requiring a deployment daemon at the other end you can push to
                            is introducing moving parts that can fail.
                        </aside>
                    </p>
                </section>

                <section>
                    <h3>Summary</h3>
                    <p>
                        <ul>
                            <li>Use other people's code</li>
                            <li>Do due dilligence first, and think about your selection criteria</li>
                            <li>Prefer big tech communities that have the resources to do proper research</li>
                        </ul>
                    </p>
                </section>

                <section data-background="img/catalyst.png" data-background-color="#fff" data-background-size="100% auto">
                </section>


            </div>

        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: false,
                progress: true,
                history: true,
                center: true,

                transition: 'fade', // none/fade/slide/convex/concave/zoom
                backgroundTransition: 'fade',

                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });

        </script>

    </body>
</html>
